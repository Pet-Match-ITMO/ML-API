#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ .env Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² CI/CD Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ML-API

set -e

ENV_FILE=".env"

echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ML-API..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
required_vars=(
    "PETS_DATABASE_PATH"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ $var Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
        exit 1
    fi
done

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
cat > "$ENV_FILE" << EOF
# ML-API Configuration
# Generated at: $(date)

# Database Configuration (S3 Storage)
PETS_DATABASE_PATH=${PETS_DATABASE_PATH}

# API Configuration
API_URL=${API_URL:-http://localhost:8001}

# Optional: Bot Configuration (if using Telegram bot)
BOT_TOKEN=${BOT_TOKEN:-}

# Optional: VK API Configuration (if using VK parser)
ACCESS_TOKEN=${ACCESS_TOKEN:-}

# Optional: LLM Configuration (if using GigaChat)
SB_AUTH_DATA=${SB_AUTH_DATA:-}

# Optional: Cache settings
CACHE_TTL=${CACHE_TTL:-300}
EOF

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°
chmod 600 "$ENV_FILE"

echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½: $ENV_FILE"
echo "ðŸ”’ ÐŸÑ€Ð°Ð²Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹: 600 (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ/Ð¿Ð¸ÑÐ°Ñ‚ÑŒ)"

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ (Ð±ÐµÐ· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²)
echo ""
echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env Ñ„Ð°Ð¹Ð»Ð°:"
echo "========================"
sed 's/=.*/=***/' "$ENV_FILE" | grep -v "^#"
echo "========================"
